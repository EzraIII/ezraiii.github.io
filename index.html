<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WYS IE Any% Sum of Best</title>
    <script>
        const get = async (url) => await fetch(url).then(resp => resp.json()).then(resp => resp.data);
        get("https://www.speedrun.com/api/v1/games/9do8nro1/levels").then(levelsArr => {
                const listOfLevels = ["A01", "A01.1", "A05", "A06", "A07", "A08", "A09", "A10", "A11", "A12", "A13", "A14", "A15", "A16", "A17", "A18", "A19", "A20", "A21", "B01", "B02", "B04", "B05", "B06", "B07", "B08", "B09", "B10", "B11", "B12", "B13", "B14", "B15", "B16", "B17", "B18", "B19", "C01", "C04", "C05", "C06", "C07", "C08", "C09", "C10", "C11", "C12", "C13", "C14", "C15", "C16", "C17", "C18", "C19", "C20", "C21", "C22", "D01", "D05", "D06", "D07", "D08", "D09", "D10", "D11", "D12", "D13", "D14", "D15", "D16", "D17", "D18", "D19", "D20", "E01", "E02", "E05", "E06", "E07", "E08", "E09", "E10", "E11", "E12", "E13", "E14", "E15", "E16", "E17", "E18", "E19"];
                const numberOfTimesInLevelSelect = 6;
                const loadingTimeEnteringLevel = 0.835;
                const timeSpentPerTripInLevelSelect = 0.845;
                let totalTime = loadingTimeEnteringLevel*(listOfLevels.length-1) + numberOfTimesInLevelSelect*timeSpentPerTripInLevelSelect;
                let processedLevels = 0;
                for(let i = 0; i < listOfLevels.length; i++){
                    const level = listOfLevels[i];
                    const levelTimePairElement = document.createElement('p');
                    levelTimePairElement.innerText = level;
                    levelTimePairElement.id = level;
                    document.body.appendChild(levelTimePairElement);
                    const levelUrl = levelsArr.find(obj => obj.name === level).links[0].uri;
                    const variableObj = {};
                    get(`${levelUrl}/variables`).then(variableArr => {
                        for(let o of variableArr) if(o["is-subcategory"]) variableObj[o.id] = o.values.default;
                    }).then(() => {
                        get(`${levelUrl}/records`).then(ilArr => {
                            const ilTime = ilArr[0].runs.find(ilObj => {
                                const keysArr = Object.keys(variableObj);
                                for(let i = 0; i < keysArr.length; i++){
                                    const key = keysArr[i];
                                    if(ilObj.run.values[key] !== variableObj[key]) return false;
                                }
                                return true;
                            }).run.times.primary_t;
                            totalTime += ilTime;
                            document.getElementById(level).innerText = `${level} : ${ilTime}`;
                        }).catch(err => {
                            console.log(level);
                            console.log(err.message);
                            document.getElementById(level).innerText = `${level} : ERROR`;
                            document.body.style = "color:#D00;";
                        }).finally(() => {
                            processedLevels++;
                            if(processedLevels === listOfLevels.length) {
                                document.getElementsByTagName("h1")[0].innerText = `${Math.floor(totalTime/60)}:${(totalTime%60).toFixed(2).length<5?`0${(totalTime%60).toFixed(2)}`:(totalTime%60).toFixed(2)}`;
                                const loadingTime = document.createElement('p');
                                loadingTime.innerText = `Loading Time and Time in Level Select : ${listOfLevels.length-1}*${loadingTimeEnteringLevel} + ${numberOfTimesInLevelSelect}*${timeSpentPerTripInLevelSelect} = ${((listOfLevels.length-1)*loadingTimeEnteringLevel + numberOfTimesInLevelSelect*timeSpentPerTripInLevelSelect).toFixed(2)}`;
                                loadingTime.id = level;
                                document.body.appendChild(loadingTime);
                            }
                        })
                    });
                }
            })
    </script>
</head>
<body>
    <h3>If the text is red, an error has occured and the time shown is not to be trusted. There is currently a bug where it fails to pull the best time from E14. I'm not yet sure how to fix this as I can't figure out how to pull it manually from the API.</h2>
    <h2>WYS IE Any% Sum of Best</h2>
    <h1>Loading</h1>
</body>
</html>